# Олимпиада Mark.Online — техническая документация

Этот документ предназначен для разработчиков и описывает архитектуру, данные и ключевые точки расширения проекта.

## Структура проекта

```
/
├─ index.html        # Меню выбора сезона/программы
├─ game.html         # Страница игры
├─ styles.css        # Стили интерфейса и поля
├─ app.js            # Логика игры, UI, состояние
├─ config.json       # Команды, стоимости, коэффициенты и правила
├─ board.json        # Поле, герои, объекты, «надзиратель»
├─ pictures/         # Изображения
└─ ТЗ/               # Техническое задание и референсы
```

## Конфигурация вариантов (`config.json`)

Файл описывает сценарий, список команд и экономику. Структура:

```json
{
  "variants": {
    "winter-j3": {
      "label": "Зимняя Олимпиада — J3",
      "commands": [
        { "id": "up", "label": "Вверх", "type": "move" }
      ],
      "stageRules": [
        {
          "id": "commands",
          "label": "Открытие команд",
          "commands": ["up", "down", "left", "right"]
        }
      ],
      "coefficients": {
        "commands": 115,
        "hero": 200,
        "final": 800
      },
      "commandCosts": {
        "up": 150,
        "left": 350,
        "right": 400,
        "down": 500,
        "jump": 600,
        "hero": 300,
        "storage": 700,
        "box": 900
      }
    }
  }
}
```

### Поля

- `commands` — полный список команд для варианта (UI + логика).
- `stageRules` — правила открытия команд по стадиям (используются вместе с `coefficients`).
- `coefficients` — пороги открытия (умножаются на количество учеников).
- `commandCosts` — стоимость каждой команды на 1 ученика.

### Добавление варианта

1. Добавьте ключ в `variants` с полным набором полей.
2. Добавьте соответствующий вариант в `board.json`.
3. Обновите массивы программ в `app.js` (`seasonPrograms`).

## Описание поля (`board.json`)

```json
{
  "variants": {
    "winter-j3": {
      "grid": {
        "columns": 10,
        "rows": 8,
        "path": [{ "x": 1, "y": 6 }, { "x": 2, "y": 6 }],
        "start": { "x": 1, "y": 6 },
        "stone": { "x": 6, "y": 3 },
        "box": { "x": 7, "y": 3 },
        "lock": { "x": 7, "y": 3 }
      },
      "heroes": [
        { "id": "vector", "name": "Вектор", "img": "pictures/vector.png", "position": { "x": 2, "y": 2 } }
      ],
      "overseer": {
        "name": "Плохишиш",
        "img": "pictures/BADSHISH-3.png",
        "caption": "Вам не победить меня!"
      }
    }
  }
}
```

### Поля

- `grid.path` — массив координат клеток пути.
- `grid.start` — стартовая позиция робота.
- `grid.stone` — препятствие (робот не проходит).
- `grid.box` — ящик для финального этапа.
- `grid.lock` — замок поверх ящика (визуальный элемент).
- `heroes` — список героев с координатами.
- `overseer` — блок «надзирателя», который рисуется над полем.

Координаты начинаются с (1,1) в левом верхнем углу; `x` растёт вправо, `y` — вниз.

## Архитектура интерфейса

### Ключевые элементы

- Меню: `index.html`, `.menu` и обработчики `showSeasonSelection`, `showProgramSelection`.
- Игровое поле: `game.html`, контейнер `#board`, построение в `renderBoard()`.
- Панель управления: `game.html`, блок `.game__controls`.

### Масштабирование поля

Функция `updateBoardScale()` в `app.js`:

- вычисляет доступный размер контейнера `.board-area__field`;
- рассчитывает коэффициент масштаба по базовым размерам (`--cell-size-base`, `--cell-gap-base`);
- сохраняет результат в CSS-переменную `--scale`.

Контейнер наблюдается через `ResizeObserver` в `ensureScaleObserver()`.

### Полноэкранный режим

- Переключение через `toggleFullscreen()` с поддержкой browser fullscreen API.
- Фоллбек — CSS-класс `body.is-fullscreen`.
- В полноэкранном режиме скрываются боковые панели и нижний блок, поле занимает всю ширину.
- Кнопка `#fullscreenExit` отображается поверх поля и вызывает тот же переключатель.

## Состояние игры

Состояние хранится в `localStorage` (`STORAGE_KEY = "mshp-olymp-state"`):

- `selectedVariant` — выбранный вариант.
- `position` — координаты робота.
- `acquiredHeroes` — собранные герои.
- `availableCommands` — открытые команды.
- `program` — текущая программа.
- `points`, `students` — баллы и число учеников.

Сброс состояния реализован через `resetState()` и подтверждение `handleReset()`.

## Ключевые функции в `app.js`

- `renderBoard()` — построение сетки и объектов.
- `renderTeam()` — отображение собранной команды.
- `updateThresholds()` — расчёт доступных команд по баллам.
- `runProgram()` / `stepProgram()` — выполнение программы.
- `executeCommand()` — обработка логики каждой команды.

## Советы по расширению

- Для нового типа объекта добавьте обработчик в `renderBoard()` и логику в `executeCommand()`.
- Для нового UI-блока используйте стили `.panel` и добавьте секцию в `game.html`.
- Для нового сезона расширьте `seasonPrograms` и проверьте соответствие данных в JSON-файлах.
